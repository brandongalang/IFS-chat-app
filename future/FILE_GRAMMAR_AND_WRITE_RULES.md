# File Grammar and Write Rules (Agentic File-First Memory v2)

Status: Draft (concept-only; pre-implementation)
Date: 2025-09-07

Purpose
These rules define how the agent edits files (snapshots) while ensuring every write is captured in structured, append-only events. They prioritize human legibility, robust targeting, auditability, and deterministic reconstruction.

1) File types and canonical sections
- User Overview (users/{userId}/overview.md)
  - Sections: Identity, Current Focus, Confirmed Parts, Active Themes, Working Agreements, Recent Highlights, Open Questions, Change Log, Extensions
- Part Profile (users/{userId}/parts/{partId}/profile.md)
  - Sections: Identity, Role, Triggers, Needs, Concerns, Allies, Polarizations, Evidence (curated), Working Agreements, Evolution, Open Questions, Change Log, Extensions
- Relationship Profile (users/{userId}/relationships/{relId}/profile.md)
  - Sections: Participants, Type, Dynamics, Evidence of Interplay, Tensions, Agreements, Evolution, Open Questions, Change Log, Extensions
- Notes (users/{userId}/notes.md; parts/.../notes.md; relationships/.../notes.md)
  - Suggested subsections: Inbox, Focus, Parking Lot, Research, Drafts

2) Anchors and headings
- Each section starts with a canonical H2 heading (e.g., "## Concerns").
- A hidden anchor ID (e.g., "[//]: # (anchor: concerns v1)" or "<!-- @anchor: concerns v1 -->") is placed immediately below the heading.
- Linting enforces presence and exact canonical names for core sections and the hidden anchor IDs.

3) Ordering and hierarchy
- H1: file title; H2: sections; H3: subsections (if needed).
- Core sections appear in fixed order as listed above; optional sections (Extensions, Open Questions, Change Log) remain at the bottom in that order.

4) Allowed operations by section type
- Narrative sections (e.g., Role, Concerns, Dynamics):
  - replace_section: replace entire section content
  - append_section: append a new paragraph (keep brief)
- List sections (e.g., Evidence (curated), Recent Highlights):
  - append_item: add a new bullet/item
  - curate_items: prune or merge items with a reason (do not silently delete; include rationale in Change Log)
- Prohibited:
  - File deletion; renaming identity fields in frontmatter; removing Change Log; removing anchors; editing IDs.

5) Evidence in snapshots (curated)
- Each Evidence entry includes a short quote plus an event token (ev:YYYYMMDDThhmmssZ-ULID) that resolves to the underlying event/log.
- Cap: 7 items per snapshot (soft cap); prefer diverse and representative items.

6) Change Log
- Two sources:
  - Daily rollup autogenerated from events (“2025-09-07: refined Active Themes; updated Part X concerns; added 2 evidence items”).
  - Inline material entries (human-readable) for significant edits (status changes, category changes, large re-writes).
- Include compact rationale (one line) referring to evidence tokens where appropriate.

7) Timestamps
- Use ISO 8601 UTC (e.g., 2025-09-07T00:00:00Z) in frontmatter last_updated and in Change Log entries.

8) Length discipline and soft caps
- Soft caps (linted):
  - Summary/narrative sections: keep under ~200–400 words.
  - Evidence (curated): 7 items per snapshot.
  - Notes subsections: keep under a few screens; periodically curate.
- Exceeding caps requires a rationale:
  - In the write event metadata (override_rationale: why it’s necessary now, expected duration, curation plan)
  - One-line note in the Change Log (e.g., "Exceeded Evidence cap to include corroborating quotes across 3 sessions; will prune after next compaction.")

9) Relationship files and grouping patterns
- Relationship files are per edge (pair + type) and follow the Relationship Profile grammar.
- Group/pattern relationships (e.g., two protectors polarized around an exile):
  - MVP: derive patterns from the set of edges and summarize major patterns in the User Overview (Active Themes/Patterns). No separate pattern files initially.
  - Evolution path: if needed later, introduce pattern files that reference parts and edges; subject to schema governance.

10) Drift and replay
- During reconstruction, events are applied to the latest snapshot:
  - If a section anchor or before_hash cannot be matched exactly, attempt one bounded re-anchor (fuzzy match to the nearest canonical section name in the same region).
  - If re-anchor fails, halt replay for that file, flag drift, and queue the issue for a maintainer review. Do not task the end user with schema/data fixes.

11) Write events (conceptual shape; non-normative)
- Minimal fields per append-only event line (ndjson):
  - event_id (ULID), ts (ISO 8601 UTC), user_id, entity_type (user|part|relationship|note), entity_id, file_path
  - op (replace_section|append_section|append_item|curate_items|tombstone_section)
  - section_anchor, before_hash, after_hash (hashing is HMAC over canonicalized JSON/text)
  - rationale (short text), evidence_refs (list of event tokens), idempotency_key, tool_call_id
  - integrity: { line_hash, algo: HMAC-SHA256, salt_version }
- Notes:
  - Events are the immutable ledger; snapshots are the human-readable “truth surface.”
  - Compaction can add chained segment hashes later; not required for MVP.

12) Notes discipline
- One notes.md per entity; use subsections for organization.
- Prefer moving durable insights from notes → profiles during curation.
- Avoid creating ad hoc note files; the single notes.md is the container for free-form thinking.

13) Governance and roles
- Users: may pin/lock sections and accept/reject agent proposals; not responsible for schema or drift resolution.
- Agent: must supply rationale and evidence tokens for material edits; must respect anchors and caps.
- Maintainers: review Extensions → Core promotions; resolve drift; tune linting and caps.

